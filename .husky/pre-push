#!/bin/sh

# Previeni loop infinito - Skip se chiamato dal release system
if [ "$SKIP_PRE_PUSH_HOOK" = "true" ]; then
    echo "🔄 Skipping pre-push hook (called from release system)"
    exit 0
fi

# Controllo se si tratta di una cancellazione di branch remoto
# Il comando `git push origin --delete branch_name` non dovrebbe lanciare hook
read local_ref local_sha remote_ref remote_sha

# Se si tratta di una cancellazione di branch (local_sha è tutto zeri), salta i controlli
if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    echo "🗑️  Branch deletion detected - skipping pre-push checks"
    exit 0
fi

# Se si tratta di creazione di branch (remote_sha è tutto zeri), esegui i controlli
if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    echo "🆕 New branch creation detected - running pre-push checks"
elif [ "$local_sha" != "$remote_sha" ]; then
    echo "🔄 Branch update detected - running pre-push checks"
else
    echo "✅ No changes detected - skipping pre-push checks"
    exit 0
fi

echo "🚀 Running pre-push checks for production readiness..."

# Quick build verification only (tests will run in CI/CD)
echo "🏗️ Verifying build..."
npm run build

echo "✅ Pre-push checks passed! Ready to push to production."

# Step 3: Automated Release Management
echo ""
echo "🔍 Checking for automated release needs..."

# Verifica se siamo sul branch main/master
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "master" ]; then
    echo "📝 Skipping release check - not on main/master branch (current: $CURRENT_BRANCH)"
    exit 0
fi

# Controllo rapido se è un commit semantico che giustifica auto-release
LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
if echo "$LAST_COMMIT_MSG" | grep -qE "^(feat|fix|BREAKING CHANGE)"; then
    echo "🚀 Semantic commit detected: $LAST_COMMIT_MSG"

    # Verifica che gli script siano disponibili
    if [ -f "scripts/auto-release.js" ] && [ -f "scripts/release-analyzer.js" ]; then
        echo "🔄 Triggering automated release..."

        # Esegue il rilascio automatico con output dettagliato
        echo "🔄 Executing: node scripts/auto-release.js --type=\"auto\""
        node scripts/auto-release.js --type="auto"
        AUTO_RELEASE_EXIT_CODE=$?

        if [ $AUTO_RELEASE_EXIT_CODE -eq 0 ]; then
            echo "🎉 Automated release completed successfully!"
        else
            echo "⚠️  Automated release failed with exit code: $AUTO_RELEASE_EXIT_CODE"
            echo "📝 Proceeding with push only - manual release may be needed"
        fi
    else
        echo "⚠️  Release scripts not found, skipping automated release"
    fi
else
    echo "📝 Non-semantic commit - proceeding with push only"
fi

echo "🚀 Pre-push hook completed successfully"
