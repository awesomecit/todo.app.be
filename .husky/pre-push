echo "üöÄ Running pre-push checks for production readiness..."

# Step 1: Full test suite with coverage enforcement
echo "üß™ Running full test suite with coverage validation..."
npm run test:coverage:check

# Step 2: Build verification
echo "üèóÔ∏è Verifying build..."
npm run build

echo "‚úÖ Pre-push checks passed! Ready to push to production."

# Step 3: Automated Release Management
echo ""
echo "üîç Checking for automated release needs..."

# Verifica se siamo sul branch main/master
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "master" ]; then
    echo "üìù Skipping release check - not on main/master branch (current: $CURRENT_BRANCH)"
    exit 0
fi

# Controlla se l'analizzatore di release √® disponibile
if [ ! -f "scripts/release-analyzer.js" ]; then
    echo "‚ö†Ô∏è  Release analyzer not found, skipping automated release"
    exit 0
fi

# Esegue l'analisi di release
echo "üîç Analyzing commits for release needs..."
ANALYSIS_RESULT=$(node scripts/release-analyzer.js --json 2>/dev/null)
ANALYSIS_EXIT_CODE=$?

if [ $ANALYSIS_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Release analysis failed, proceeding with push only"
    exit 0
fi

# Parse del JSON per determinare se √® necessario un rilascio
NEEDS_RELEASE=$(echo "$ANALYSIS_RESULT" | node -pe "JSON.parse(require('fs').readFileSync(0, 'utf8')).analysis.needsRelease")
RELEASE_TYPE=$(echo "$ANALYSIS_RESULT" | node -pe "JSON.parse(require('fs').readFileSync(0, 'utf8')).analysis.releaseType")

if [ "$NEEDS_RELEASE" = "true" ]; then
    echo "‚úÖ Release needed: $RELEASE_TYPE"

    # Controlla se ci sono commit semantici che giustificano auto-release
    LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
    AUTO_RELEASE=false
    
    # Verifica pattern semantici che richiedono auto-release
    if echo "$LAST_COMMIT_MSG" | grep -qE "^(feat|fix|BREAKING CHANGE)"; then
        AUTO_RELEASE=true
        echo "üöÄ Auto-releasing for semantic commit: $LAST_COMMIT_MSG"
    fi

    # Chiede conferma all'utente solo per commit non-semantici (e non in CI/CD)
    if [ "$AUTO_RELEASE" = "false" ] && [ -z "$CI" ] && [ -z "$GITHUB_ACTIONS" ] && [ -z "$GITLAB_CI" ]; then
        echo ""
        echo "ü§î Do you want to create an automated release? (y/N)"
        read -r REPLY

        if [ "$REPLY" = "y" ] || [ "$REPLY" = "Y" ]; then
            AUTO_RELEASE=true
        fi
    fi

    if [ "$AUTO_RELEASE" = "true" ]; then
        echo "üîÑ Triggering automated release..."

        # Esegue il rilascio automatico
        if [ -f "scripts/auto-release.js" ]; then
            node scripts/auto-release.js --type="$RELEASE_TYPE"
            AUTO_RELEASE_EXIT_CODE=$?

            if [ $AUTO_RELEASE_EXIT_CODE -eq 0 ]; then
                echo "üéâ Automated release completed successfully!"
            else
                echo "‚ùå Automated release failed (exit code: $AUTO_RELEASE_EXIT_CODE)"
                echo "üìù Proceeding with push anyway..."
                fi
            else
                echo "‚ö†Ô∏è  Auto-release script not found, skipping automated release"
            fi
        else
            echo "üìù Skipping automated release (user choice)"
        fi
    else
        echo "ü§ñ CI/CD environment detected, skipping interactive release"
        echo "üìù Use 'npm run release:auto' manually if release is needed"
    fi
else
    echo "üìù No release needed - proceeding with push"
fi

echo "üöÄ Pre-push hook completed successfully"
