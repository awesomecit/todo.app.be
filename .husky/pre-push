#!/bin/sh

# Previeni loop infinito - Skip se chiamato dal release system
if [ "$SKIP_PRE_PUSH_HOOK" = "true" ]; then
    echo "ğŸ”„ Skipping pre-push hook (called from release system)"
    exit 0
fi

echo "ğŸš€ Running pre-push checks for production readiness..."

# Step 1: Full test suite with coverage enforcement  
echo "ğŸ§ª Running full test suite with coverage validation..."
npm run test:coverage:check

# Step 2: Build verification
echo "ğŸ—ï¸ Verifying build..."
npm run build

echo "âœ… Pre-push checks passed! Ready to push to production."

# Step 3: Automated Release Management
echo ""
echo "ğŸ” Checking for automated release needs..."

# Verifica se siamo sul branch main/master
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "master" ]; then
    echo "ğŸ“ Skipping release check - not on main/master branch (current: $CURRENT_BRANCH)"
    exit 0
fi

# Controllo rapido se Ã¨ un commit semantico che giustifica auto-release
LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
if echo "$LAST_COMMIT_MSG" | grep -qE "^(feat|fix|BREAKING CHANGE)"; then
    echo "ğŸš€ Semantic commit detected: $LAST_COMMIT_MSG"
    
    # Verifica che gli script siano disponibili
    if [ -f "scripts/auto-release.js" ] && [ -f "scripts/release-analyzer.js" ]; then
        echo "ğŸ”„ Triggering automated release..."
        
        # Esegue il rilascio automatico
        node scripts/auto-release.js --type="auto" 2>/dev/null
        AUTO_RELEASE_EXIT_CODE=$?
        
        if [ $AUTO_RELEASE_EXIT_CODE -eq 0 ]; then
            echo "ğŸ‰ Automated release completed successfully!"
        else
            echo "âš ï¸  Automated release failed, proceeding with push only"
        fi
    else
        echo "âš ï¸  Release scripts not found, skipping automated release"
    fi
else
    echo "ğŸ“ Non-semantic commit - proceeding with push only"
fi

echo "ğŸš€ Pre-push hook completed successfully"
